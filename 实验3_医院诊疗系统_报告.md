# 实验3：医院诊疗系统（用户信息管理应用）

- 课程/实验：Qt MVC + Qt SQL + TableView/Delegate + QStackedWidget
- 开发者信息：学号/姓名请在 `appinfo.h` 中填写（界面右下角状态栏会显示）
- 默认账号：`admin` / `123456`

---

## 一、实验目标

1. 理解 View/Model 编程框架，了解 `QStackedWidget` 的使用技巧  
2. 掌握 Qt SQL 数据库模块的使用（连接、查询、增删改）  
3. 掌握 `QTableView` 等视图组件的使用，并用自定义代理完成数据编辑  
4. 熟悉工具栏定制，采用代码化方式添加控件（`QToolBar + QAction`）  
5. 掌握利用 `QSqlQuery` 实现通用查询（封装执行/查询模型）  

---

## 二、实验条件

- 系统：Windows 64 位（本项目使用 SQLite，本地即可运行）
- 软件：Qt 6.7.3、Git

---

## 三、实验内容与完成情况

必做：

- MVC 模式：`Model(QSqlTableModel/QSqlRelationalTableModel)` + `View(QTableView)` + `Controller(Page/Dialog)`  
- 登录检测：查询 `User` 表  
- 患者信息管理：列表显示、查询、增加、删除、修改  
- 界面显示开发者信息：状态栏显示“学号/姓名”  

选做（已实现）：

- 科室管理、医生管理  
- 用户操作记录保存与查询（History 页面）  

---

## 四、实验步骤及结果（含截图位置）

说明：请将你运行后的截图保存到 `docs/images/`，并按下列文件名放置，Markdown 会自动显示。

### 1）设计数据库（Navicat 建表）

项目提供数据库结构脚本：`sql/schema.sql`

Navicat（以 SQLite 为例）：

1. 新建连接 → SQLite（或 MySQL 也可）  
2. 新建数据库文件（SQLite）或新建库（MySQL）  
3. 打开查询窗口，执行 `sql/schema.sql` 内容  
4. 确认生成表：`User / Patient / Department / Doctor / History`  

截图：

- `docs/images/01_schema.png`（Navicat 中表结构/ER 图或建表 SQL 执行结果）

![数据库设计/建表结果](docs/images/01_schema.png)

### 2）设计初步 UI

实现文件：

- 登录页：`ui/loginpage.*`
- 主页：`ui/homepage.*`

截图：

- `docs/images/02_login.png`（登录页）
- `docs/images/03_home.png`（主页三按钮）

![登录界面](docs/images/02_login.png)
![主页界面](docs/images/03_home.png)

### 3）实现界面切换（QStackedWidget）

实现文件：

- 主窗口 + 页面栈：`mainwindow.*`（`QStackedWidget` 管理 Login/Home/Patients/Doctors/Departments/History）
- 工具栏：`mainwindow.cpp`（代码添加 `QToolBar` 与 `QAction`：返回/操作记录/退出登录）

截图：

- `docs/images/04_stack.png`（从主页进入“患者管理/医生管理/科室管理”任一页面，展示可切换）

![页面切换](docs/images/04_stack.png)

### 4）添加数据库支持（Qt SQL）

实现文件：

- `db/dbmanager.*`：SQLite 连接、建表、默认账号、通用 `exec()` 与 `createQueryModel()`（均基于 `QSqlQuery`）

运行行为：

- 首次运行会自动创建数据库文件（位于系统 AppData 目录），并自动建表、插入默认用户 `admin/123456`

截图：

- `docs/images/05_db.png`（程序运行后在数据库里看到表/数据，或程序正常显示列表）

![数据库支持](docs/images/05_db.png)

### 5）实现登录控制

实现逻辑：

- 登录：`ui/loginpage.cpp` 使用 `QSqlQuery` 预编译查询 `User` 表
- 成功后进入主页，并写入历史记录：`db/historylogger.*`

截图：

- `docs/images/06_login_ok.png`（输入正确账号后进入主页，状态栏显示“当前用户 + 学号姓名”）

![登录控制](docs/images/06_login_ok.png)

### 6）实现患者信息列表显示、查询、删除

实现文件：

- Model：`models/patientmodel.*`（`QSqlTableModel`，支持关键字过滤）
- Delegate：`delegates/patientdelegate.*`（性别/日期/数值编辑器，双击单元格可编辑）
- View + Controller：`ui/patientpage.*`（`QTableView` + 查找/添加/删除/修改）

截图：

- `docs/images/07_patient_list.png`（患者管理列表）
- `docs/images/08_patient_search.png`（关键字查询效果）
- `docs/images/09_patient_delete.png`（删除提示/删除后列表变化）

![患者列表](docs/images/07_patient_list.png)
![患者查询](docs/images/08_patient_search.png)
![患者删除](docs/images/09_patient_delete.png)

### 7）实现患者信息的添加与修改

实现文件：

- 编辑对话框：`ui/patienteditdialog.*`
- 增改逻辑：`ui/patientpage.cpp`（`INSERT/UPDATE` 均采用 `QSqlQuery` 绑定参数）

截图：

- `docs/images/10_patient_add.png`（添加对话框）
- `docs/images/11_patient_edit.png`（修改对话框或修改后列表）

![添加患者](docs/images/10_patient_add.png)
![修改患者](docs/images/11_patient_edit.png)

---

## 五、选做功能（如需要可截图补充）

### 1）科室管理

- `models/departmentmodel.*`、`ui/departmentpage.*`、`ui/departmenteditdialog.*`

截图（可选）：

- `docs/images/12_department.png`

![科室管理](docs/images/12_department.png)

### 2）医生管理（带科室关联）

- `models/doctormodel.*` 使用 `QSqlRelationalTableModel` 关联 `Department`
- `ui/doctorpage.*`、`ui/doctoreditdialog.*`

截图（可选）：

- `docs/images/13_doctor.png`

![医生管理](docs/images/13_doctor.png)

### 3）用户操作记录保存与查询

- 写入：`db/historylogger.*`
- 查询页面：`ui/historypage.*`（使用 `DbManager::createQueryModel()` 实现通用查询并展示）

截图（可选）：

- `docs/images/14_history.png`

![操作记录](docs/images/14_history.png)

---

## 六、Github 日志与上传要求（实验3相关提交）

建议至少 5 次提交（示例）：

1. `init: Qt project skeleton`
2. `feat: add db layer and login`
3. `feat: patient CRUD + delegate + stacked navigation`
4. `chore: fill in student info`
5. `ui: simplify toolbar and center history`

上传步骤（Windows PowerShell）：

1. 初始化并提交：

```bash
git init
git add .
git commit -m "feat: hospital system (exp3)"
```

2. 在 GitHub 创建一个新仓库（例如：`test3-hospital`），复制仓库地址，然后：

```bash
git remote add origin <你的仓库地址>
git branch -M main
git push -u origin main
```

3. 查看提交记录（截图可选）：

```bash
git log --oneline --decorate --graph
```

截图（可选）：

- `docs/images/15_gitlog.png`

![Git 提交记录](docs/images/15_gitlog.png)

---

## 七、测试视频录制步骤（提交附件）

### 方案A：Windows Xbox Game Bar（推荐，免安装）

1. 打开程序并准备演示流程  
2. 按 `Win + G` 打开游戏栏  
3. 点击“捕获” → “开始录制”（或 `Win + Alt + R`）  
4. 按同样快捷键停止录制  
5. 视频默认保存位置：`视频\捕获`（Videos\Captures）

建议演示顺序：

- 登录（admin/123456）
- 进入患者管理：查找 → 添加 → 修改 → 删除  
- （选做）进入科室/医生管理：添加/修改/删除  
- （选做）打开“操作记录”页面展示历史记录  

### 方案B：OBS Studio（可选）

1. 安装 OBS → 新建“显示捕获”或“窗口捕获”  
2. 设置输出路径与格式（mp4）  
3. 开始录制 → 演示 → 停止录制  

---

## 八、实验总结（出错分析与解决）

1. **数据库驱动未加载（QSQLITE）**  
   - 现象：`QSqlDatabase: QSQLITE driver not loaded`  
   - 解决：确认 Qt 安装包含 SQL 驱动插件；Qt Creator Kit 使用的 Qt 路径正确；运行目录能找到 `sqldrivers` 插件。  

2. **数据库文件路径不可写**  
   - 现象：数据库打开失败，提示无法创建文件  
   - 解决：使用 `QStandardPaths::AppDataLocation` 作为存放目录，并在代码中 `mkpath`。  

3. **TableView 编辑体验不佳/数据类型不匹配**  
   - 现象：性别/日期/数值列直接编辑容易输入错误  
   - 解决：对 `Patient` 表的关键列实现 `QStyledItemDelegate`，提供 `QComboBox/QDateEdit/SpinBox` 等编辑器。  

4. **查询过滤存在特殊字符导致 LIKE 失败**  
   - 现象：搜索包含 `%`、`_` 时结果异常  
   - 解决：对关键字进行 LIKE 转义（`%/_/\\`），并使用 `ESCAPE '\\'`。  

5. **界面切换逻辑混乱**  
   - 现象：不同页面之间返回/主页/记录跳转逻辑不统一  
   - 解决：主窗口统一用 `QStackedWidget` 管理页面，并集中控制工具栏显示与跳转。  

---

## 九、运行说明

1. 用 Qt Creator 打开 `test3.pro`  
2. 选择 Qt 6.7.3 Kit → 构建并运行  
3. 登录默认账号：`admin / 123456`  
4. 在 `appinfo.h` 填写你的学号与姓名（状态栏显示）  
